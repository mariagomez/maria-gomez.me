<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>How to log audit information with Dropwizard &#8211; Continuous Learner</title>
<meta name="description" content="">
<meta name="keywords" content="dropwizard, audit, java, microservices">
<!-- Twitter Cards -->
	
		<meta name="twitter:card" content="summary">
		<meta name="twitter:image" content=
			
				
						"http://maria-gomez.me//images/"
				
			
		>
	
	<meta name="twitter:title" content="How to log audit information with Dropwizard">
	<meta name="twitter:description" content="Continuous Learner by Maria Gomez">
	<meta name="twitter:creator" content="@mariascandella">


<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="How to log audit information with Dropwizard">
<meta property="og:description" content="Continuous Learner by Maria Gomez">
<meta property="og:url" content="http://maria-gomez.me//software/how-to-log-audit-information-with-dropwizard/">
<meta property="og:site_name" content="Continuous Learner">





<link rel="canonical" href="http://maria-gomez.me//software/how-to-log-audit-information-with-dropwizard/">
<link href="http://maria-gomez.me//feed.xml" type="application/atom+xml" rel="alternate" title="Continuous Learner Feed">
<link rel="author" href="http://plus.google.com/+mariagomezaguirre?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="http://maria-gomez.me//assets/css/main.min.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://maria-gomez.me//assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://maria-gomez.me//assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://maria-gomez.me//assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://maria-gomez.me//favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://maria-gomez.me//favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://maria-gomez.me//images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://maria-gomez.me//images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://maria-gomez.me//images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://maria-gomez.me//images/apple-touch-icon-144x144-precomposed.png">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55460651-1', 'auto');
  ga('send', 'pageview');

</script>

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://maria-gomez.me/">Continuous Learner</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				<li><a href="http://maria-gomez.me//about/" >About</a></li>
		        
				<li><a href="http://maria-gomez.me//posts/" >Posts</a></li>
		        
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    
	<img src="http://maria-gomez.me//images/me_fall_2013.jpg" class="bio-photo" alt="Maria Gomez bio photo"></a>

<h3>Maria Gomez</h3>
<p>Software Developer. Agile Coach. Thoughtworker.</p>
<a href="http://twitter.com/mariascandella" class="author-social" target="_blank"><i class="icon-twitter"></i> Twitter</a>

<a href="http://plus.google.com/+mariagomezaguirre" class="author-social" target="_blank"><i class="icon-google-plus"></i> Google+</a>
<a href="http://linkedin.com/in/mariagomezaguirre" class="author-social" target="_blank"><i class="icon-linkedin"></i> LinkedIn</a>
<a href="http://instagram.com/mscandella" class="author-social" target="_blank"><i class="icon-instagram"></i> Instagram</a>

<a href="http://github.com/mariagomez" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>






  </div>
  <article>
    <div class="headline-wrap">
      
        <h1><a href="http://maria-gomez.me//software/how-to-log-audit-information-with-dropwizard/" rel="bookmark" title="How to log audit information with Dropwizard">How to log audit information with Dropwizard</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>For those who don’t know, <a href="dropwizard.github.io/dropwizard/">Dropwizard</a> is Java framework that allows you to build light-weight RESTful webservices. It comes with a few functionalities already configured and ready to use like an embedded Jetty container and the <a href="https://jersey.java.net/">Jersey</a> framework for building webservices. It also allows you to add more functionality as you need by importing or creating <i><a href="https://dropwizard.github.io/dropwizard/manual/core.html#bundles">bundles</a></i>. This framework is currently very popular among the Java community and it’s being used as an alternative of the much heavier enterprise options. The <a href="http://www.thoughtworks.com/radar/languages-and-frameworks/dropwizard">Thoughtworks Tech Radar</a> shows it on the Adopt ring, meaning we promote and recommend its use. In our project we are using Dropwizard to build a set of microservices that are consumed by a single page app.
<br /><br />
Although it has a really active community and it’s improving pretty fast, the framework is not mature yet and therefore there are some functionalities or requirements that are not available out of the box. One of them is the <a href="http://en.wikipedia.org/wiki/Audit_trail">audit trail</a>, that is, keeping a record of the transactions done by the users in the system that is not intrusive for them and respect their sensitive information. When we talk about webservices, we can try a few approaches:</p>

<ul>
  <li>Log at the persistence layer. When there is a change in any table or entity you can trigger a procedure that will record the change. Hibernate has something called <a href="http://envers.jboss.org/">Envers</a> that at first seems like an easy way to do this but we could not make it work as we were not using J2EE and the library is only available as part of the enterprise package . Another reason not to go down this path is that there doesn’t seem to be a way of separating the audit tables from the normal tables so the database can grow really quickly and there may be some performance issues related to that.
  <br /><br /></li>
  <li>Log using DB hooks or interceptors that get called when the DB is about to get modified.
  <br /><br /></li>
  <li>Log at the resource level. When a request came to the server, log the content of it as well as the additional information you need. Jersey allows you to easily register MethodDispatcher that will decorate your resources with new functionality. I did some research in the DW mailing list and found this <a href="https://gist.github.com/ryankennedy/6688601">gist</a>, which gave the confirmation and inspiration we needed to follow this path.</li>
</ul>

<h3 id="creating-the-audit-bundle-in-dw">Creating the audit bundle in DW</h3>

<p>Creating a dispatcher is easy enough, our looks like this:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kn">package</span> <span class="n">me</span><span class="o">.</span><span class="na">mariagomez</span><span class="o">.</span><span class="na">dropwizard</span><span class="o">.</span><span class="na">audit</span><span class="o">;</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">com.fasterxml.jackson.core.JsonProcessingException</span><span class="o">;</span>
<span class="lineno"> 4</span> <span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>
<span class="lineno"> 5</span> <span class="kn">import</span> <span class="nn">com.sun.jersey.api.core.HttpContext</span><span class="o">;</span>
<span class="lineno"> 6</span> <span class="kn">import</span> <span class="nn">com.sun.jersey.spi.dispatch.RequestDispatcher</span><span class="o">;</span>
<span class="lineno"> 7</span> <span class="kn">import</span> <span class="nn">io.dropwizard.jackson.Jackson</span><span class="o">;</span>
<span class="lineno"> 8</span> <span class="kn">import</span> <span class="nn">me.mariagomez.dropwizard.audit.providers.PrincipalProvider</span><span class="o">;</span>
<span class="lineno"> 9</span> <span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="o">;</span>
<span class="lineno">10</span> <span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="lineno">11</span> <span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="kn">import</span> <span class="nn">static</span> <span class="n">me</span><span class="o">.</span><span class="na">mariagomez</span><span class="o">.</span><span class="na">dropwizard</span><span class="o">.</span><span class="na">audit</span><span class="o">.</span><span class="na">Constants</span><span class="o">.</span><span class="na">X_REMOTE_ADDR</span><span class="o">;</span>
<span class="lineno">14</span> 
<span class="lineno">15</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuditRequestDispatcher</span> <span class="kd">implements</span> <span class="n">RequestDispatcher</span> <span class="o">{</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>   <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ObjectMapper</span> <span class="n">MAPPER</span> <span class="o">=</span> <span class="n">Jackson</span><span class="o">.</span><span class="na">newObjectMapper</span><span class="o">();</span>
<span class="lineno">18</span>   <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">AuditRequestDispatcher</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>   <span class="kd">private</span> <span class="n">RequestDispatcher</span> <span class="n">dispatcher</span><span class="o">;</span>
<span class="lineno">21</span>   <span class="kd">private</span> <span class="n">AuditWriter</span> <span class="n">auditWriter</span><span class="o">;</span>
<span class="lineno">22</span>   <span class="kd">private</span> <span class="n">PrincipalProvider</span> <span class="n">principalProvider</span><span class="o">;</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>   <span class="kd">public</span> <span class="nf">AuditRequestDispatcher</span><span class="o">(</span><span class="n">RequestDispatcher</span> <span class="n">dispatcher</span><span class="o">,</span> <span class="n">AuditWriter</span> <span class="n">auditWriter</span><span class="o">,</span>
<span class="lineno">25</span>                             <span class="n">PrincipalProvider</span> <span class="n">principalProvider</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">26</span>     <span class="k">this</span><span class="o">.</span><span class="na">dispatcher</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="o">;</span>
<span class="lineno">27</span>     <span class="k">this</span><span class="o">.</span><span class="na">auditWriter</span> <span class="o">=</span> <span class="n">auditWriter</span><span class="o">;</span>
<span class="lineno">28</span>     <span class="k">this</span><span class="o">.</span><span class="na">principalProvider</span> <span class="o">=</span> <span class="n">principalProvider</span><span class="o">;</span>
<span class="lineno">29</span>   <span class="o">}</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>   <span class="nd">@Override</span>
<span class="lineno">32</span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dispatch</span><span class="o">(</span><span class="n">Object</span> <span class="n">resource</span><span class="o">,</span> <span class="n">HttpContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">33</span>     <span class="n">dispatcher</span><span class="o">.</span><span class="na">dispatch</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
<span class="lineno">34</span> 
<span class="lineno">35</span>     <span class="kt">int</span> <span class="n">responseCode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">getStatus</span><span class="o">();</span>
<span class="lineno">36</span>     <span class="k">if</span> <span class="o">(</span><span class="n">responseCode</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="o">||</span> <span class="n">responseCode</span> <span class="o">&gt;</span> <span class="mi">299</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">37</span>         <span class="k">return</span><span class="o">;</span>
<span class="lineno">38</span>     <span class="o">}</span>
<span class="lineno">39</span>     <span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getMethod</span><span class="o">();</span>
<span class="lineno">40</span>     <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getPath</span><span class="o">();</span>
<span class="lineno">41</span>     <span class="n">String</span> <span class="n">remoteAddress</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getRequestHeaders</span><span class="o">().</span><span class="na">getFirst</span><span class="o">(</span><span class="n">X_REMOTE_ADDR</span><span class="o">);</span>
<span class="lineno">42</span>     <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">principalProvider</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
<span class="lineno">43</span>     <span class="n">DateTime</span> <span class="n">date</span> <span class="o">=</span> <span class="n">DateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
<span class="lineno">44</span> 
<span class="lineno">45</span>     <span class="n">String</span> <span class="n">entity</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">46</span>     <span class="k">try</span> <span class="o">{</span>
<span class="lineno">47</span>         <span class="n">entity</span> <span class="o">=</span> <span class="n">MAPPER</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">getEntity</span><span class="o">());</span>
<span class="lineno">48</span>     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JsonProcessingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">49</span>         <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Error while parsing the entity. \n Message: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
<span class="lineno">50</span>     <span class="o">}</span>
<span class="lineno">51</span> 
<span class="lineno">52</span>     <span class="n">AuditInfo</span> <span class="n">auditInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AuditInfo</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">responseCode</span><span class="o">,</span> <span class="n">date</span><span class="o">,</span> <span class="n">entity</span><span class="o">,</span> <span class="n">path</span><span class="o">,</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
<span class="lineno">53</span>     <span class="n">auditWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">auditInfo</span><span class="o">);</span>
<span class="lineno">54</span>   <span class="o">}</span>
<span class="lineno">55</span> <span class="o">}</span></code></pre></div>

<p>As you can see, we let the dispatcher’s flow continue and we insert our logic after the request has been processed. This is because we only want to audit the successful requests. We also have a PrincipalProvider injected as a dependency, this gives us the info about the user making the request.
<br /><br />
Next we attach this dispatcher to the resource by using a Provider:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kn">package</span> <span class="n">me</span><span class="o">.</span><span class="na">mariagomez</span><span class="o">.</span><span class="na">dropwizard</span><span class="o">.</span><span class="na">audit</span><span class="o">;</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">com.sun.jersey.api.model.AbstractResourceMethod</span><span class="o">;</span>
<span class="lineno"> 4</span> <span class="kn">import</span> <span class="nn">com.sun.jersey.spi.container.ResourceMethodDispatchProvider</span><span class="o">;</span>
<span class="lineno"> 5</span> <span class="kn">import</span> <span class="nn">com.sun.jersey.spi.dispatch.RequestDispatcher</span><span class="o">;</span>
<span class="lineno"> 6</span> <span class="kn">import</span> <span class="nn">me.mariagomez.dropwizard.audit.providers.PrincipalProvider</span><span class="o">;</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="lineno"> 9</span> <span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuditMethodDispatchProvider</span> <span class="kd">implements</span> <span class="n">ResourceMethodDispatchProvider</span> <span class="o">{</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>     <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">AUDITABLE_METHODS</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;POST&quot;</span><span class="o">,</span> <span class="s">&quot;PUT&quot;</span><span class="o">,</span> <span class="s">&quot;DELETE&quot;</span><span class="o">);</span>
<span class="lineno">14</span>     <span class="kd">private</span> <span class="n">ResourceMethodDispatchProvider</span> <span class="n">provider</span><span class="o">;</span>
<span class="lineno">15</span>     <span class="kd">private</span> <span class="n">AuditWriter</span> <span class="n">auditWriter</span><span class="o">;</span>
<span class="lineno">16</span>     <span class="kd">private</span> <span class="n">PrincipalProvider</span> <span class="n">principalProvider</span><span class="o">;</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>     <span class="kd">public</span> <span class="nf">AuditMethodDispatchProvider</span><span class="o">(</span><span class="n">ResourceMethodDispatchProvider</span> <span class="n">provider</span><span class="o">,</span> <span class="n">AuditWriter</span> <span class="n">auditWriter</span><span class="o">,</span>
<span class="lineno">19</span>                                        <span class="n">PrincipalProvider</span> <span class="n">principalProvider</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">20</span>         <span class="k">this</span><span class="o">.</span><span class="na">provider</span> <span class="o">=</span> <span class="n">provider</span><span class="o">;</span>
<span class="lineno">21</span>         <span class="k">this</span><span class="o">.</span><span class="na">auditWriter</span> <span class="o">=</span> <span class="n">auditWriter</span><span class="o">;</span>
<span class="lineno">22</span>         <span class="k">this</span><span class="o">.</span><span class="na">principalProvider</span> <span class="o">=</span> <span class="n">principalProvider</span><span class="o">;</span>
<span class="lineno">23</span>     <span class="o">}</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>     <span class="nd">@Override</span>
<span class="lineno">26</span>     <span class="kd">public</span> <span class="n">RequestDispatcher</span> <span class="nf">create</span><span class="o">(</span><span class="n">AbstractResourceMethod</span> <span class="n">abstractResourceMethod</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">27</span>         <span class="n">RequestDispatcher</span> <span class="n">requestDispatcher</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">abstractResourceMethod</span><span class="o">);</span>
<span class="lineno">28</span>         <span class="k">if</span> <span class="o">(</span><span class="n">isMethodAuditable</span><span class="o">(</span><span class="n">abstractResourceMethod</span><span class="o">.</span><span class="na">getHttpMethod</span><span class="o">())){</span>
<span class="lineno">29</span>             <span class="k">return</span> <span class="k">new</span> <span class="nf">AuditRequestDispatcher</span><span class="o">(</span><span class="n">requestDispatcher</span><span class="o">,</span> <span class="n">auditWriter</span><span class="o">,</span> <span class="n">principalProvider</span><span class="o">);</span>
<span class="lineno">30</span>         <span class="o">}</span>
<span class="lineno">31</span>         <span class="k">return</span> <span class="n">requestDispatcher</span><span class="o">;</span>
<span class="lineno">32</span>     <span class="o">}</span>
<span class="lineno">33</span> 
<span class="lineno">34</span>     <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isMethodAuditable</span><span class="o">(</span><span class="n">String</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">35</span>         <span class="k">return</span> <span class="n">AUDITABLE_METHODS</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
<span class="lineno">36</span>     <span class="o">}</span>
<span class="lineno">37</span> 
<span class="lineno">38</span> <span class="o">}</span></code></pre></div>

<p>In our case, we wanted the dispatcher to be attached to all resources with POST, PUT and DELETE verbs, but the <a href="https://gist.github.com/ryankennedy/6688601">gist</a> I mentioned before shows how to do this by using an annotation instead.
<br /><br />
Once we have all this in place, we just need to create the bundle so we can use this functionality within our application. Bundles in Dropwizard can have access to the configuration files so we took advantage of that to allow different writers (initially we only used the normal logs but you can link to a writer that send the data somewhere else).</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kn">package</span> <span class="n">me</span><span class="o">.</span><span class="na">mariagomez</span><span class="o">.</span><span class="na">dropwizard</span><span class="o">.</span><span class="na">audit</span><span class="o">;</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">io.dropwizard.Configuration</span><span class="o">;</span>
<span class="lineno"> 4</span> <span class="kn">import</span> <span class="nn">io.dropwizard.ConfiguredBundle</span><span class="o">;</span>
<span class="lineno"> 5</span> <span class="kn">import</span> <span class="nn">io.dropwizard.jersey.setup.JerseyEnvironment</span><span class="o">;</span>
<span class="lineno"> 6</span> <span class="kn">import</span> <span class="nn">io.dropwizard.setup.Bootstrap</span><span class="o">;</span>
<span class="lineno"> 7</span> <span class="kn">import</span> <span class="nn">io.dropwizard.setup.Environment</span><span class="o">;</span>
<span class="lineno"> 8</span> <span class="kn">import</span> <span class="nn">me.mariagomez.dropwizard.audit.filters.RemoteAddressFilter</span><span class="o">;</span>
<span class="lineno"> 9</span> <span class="kn">import</span> <span class="nn">me.mariagomez.dropwizard.audit.providers.PrincipalProvider</span><span class="o">;</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuditBundle</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">Configuration</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">ConfiguredBundle</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>     <span class="kd">private</span> <span class="n">AuditWriter</span> <span class="n">auditWriter</span><span class="o">;</span>
<span class="lineno">14</span>     <span class="kd">private</span> <span class="n">PrincipalProvider</span> <span class="n">principalProvider</span><span class="o">;</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="kd">public</span> <span class="nf">AuditBundle</span><span class="o">(</span><span class="n">AuditWriter</span> <span class="n">auditWriter</span><span class="o">,</span> <span class="n">PrincipalProvider</span> <span class="n">principalProvider</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">17</span>         <span class="k">this</span><span class="o">.</span><span class="na">auditWriter</span> <span class="o">=</span> <span class="n">auditWriter</span><span class="o">;</span>
<span class="lineno">18</span>         <span class="k">this</span><span class="o">.</span><span class="na">principalProvider</span> <span class="o">=</span> <span class="n">principalProvider</span><span class="o">;</span>
<span class="lineno">19</span>     <span class="o">}</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>     <span class="nd">@Override</span>
<span class="lineno">22</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">T</span> <span class="n">configuration</span><span class="o">,</span> <span class="n">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">23</span>         <span class="n">JerseyEnvironment</span> <span class="n">jersey</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">jersey</span><span class="o">();</span>
<span class="lineno">24</span>         <span class="n">jersey</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="nf">AuditMethodDispatchAdapter</span><span class="o">(</span><span class="n">auditWriter</span><span class="o">,</span> <span class="n">principalProvider</span><span class="o">));</span>
<span class="lineno">25</span>         <span class="n">jersey</span><span class="o">.</span><span class="na">getResourceConfig</span><span class="o">().</span><span class="na">getContainerRequestFilters</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">RemoteAddressFilter</span><span class="o">());</span>
<span class="lineno">26</span>     <span class="o">}</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>     <span class="nd">@Override</span>
<span class="lineno">29</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Bootstrap</span><span class="o">&lt;?&gt;</span> <span class="n">bootstrap</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">30</span>         <span class="c1">// Do nothing</span>
<span class="lineno">31</span>     <span class="o">}</span>
<span class="lineno">32</span> <span class="o">}</span></code></pre></div>

<p>Finally, you need to register the bundle in your application:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kn">package</span> <span class="n">me</span><span class="o">.</span><span class="na">mariagomez</span><span class="o">.</span><span class="na">dropwizard</span><span class="o">.</span><span class="na">audit</span><span class="o">.</span><span class="na">example</span><span class="o">;</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="kn">import</span> <span class="nn">io.dropwizard.Application</span><span class="o">;</span>
<span class="lineno"> 4</span> <span class="kn">import</span> <span class="nn">io.dropwizard.setup.Bootstrap</span><span class="o">;</span>
<span class="lineno"> 5</span> <span class="kn">import</span> <span class="nn">io.dropwizard.setup.Environment</span><span class="o">;</span>
<span class="lineno"> 6</span> <span class="kn">import</span> <span class="nn">me.mariagomez.dropwizard.audit.AuditBundle</span><span class="o">;</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleApplication</span> <span class="kd">extends</span> <span class="n">Application</span><span class="o">&lt;</span><span class="n">ExampleConfiguration</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>     <span class="nd">@Override</span>
<span class="lineno">11</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Bootstrap</span><span class="o">&lt;</span><span class="n">ExampleConfiguration</span><span class="o">&gt;</span> <span class="n">bootstrap</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="n">AuditBundle</span><span class="o">&lt;</span><span class="n">ExampleConfiguration</span><span class="o">&gt;</span> <span class="n">bundle</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuditBundle</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nf">PrincipalProviderImpl</span><span class="o">());</span>
<span class="lineno">13</span>         <span class="n">bootstrap</span><span class="o">.</span><span class="na">addBundle</span><span class="o">(</span><span class="n">bundle</span><span class="o">);</span>
<span class="lineno">14</span>     <span class="o">}</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="nd">@Override</span>
<span class="lineno">17</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ExampleConfiguration</span> <span class="n">configuration</span><span class="o">,</span> <span class="n">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="lineno">18</span>         <span class="n">environment</span><span class="o">.</span><span class="na">jersey</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">ExampleResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">19</span>     <span class="o">}</span>
<span class="lineno">20</span> <span class="o">}</span></code></pre></div>

<p>And you should be good to go!
<br /><br />
PS: All the code plus an example is in <a href="https://github.com/mariagomez/dropwizard-audit">this project on github</a>. Contribution are more than welcome.</p>

      <hr />
      <footer role="contentinfo">
        <div class="article-author-bottom">
          
	<img src="http://maria-gomez.me//images/me_fall_2013.jpg" class="bio-photo" alt="Maria Gomez bio photo"></a>

<h3>Maria Gomez</h3>
<p>Software Developer. Agile Coach. Thoughtworker.</p>
<a href="http://twitter.com/mariascandella" class="author-social" target="_blank"><i class="icon-twitter"></i> Twitter</a>

<a href="http://plus.google.com/+mariagomezaguirre" class="author-social" target="_blank"><i class="icon-google-plus"></i> Google+</a>
<a href="http://linkedin.com/in/mariagomezaguirre" class="author-social" target="_blank"><i class="icon-linkedin"></i> LinkedIn</a>
<a href="http://instagram.com/mscandella" class="author-social" target="_blank"><i class="icon-instagram"></i> Instagram</a>

<a href="http://github.com/mariagomez" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>






        </div>
        <p class="byline"><strong>How to log audit information with Dropwizard</strong> was published on <time datetime="2015-06-04T00:00:00-04:00">June 04, 2015</time> and last modified on <time datetime="2015-06-04">June 04, 2015</time> by <a href="http://maria-gomez.me//about" title="About Maria Gomez">Maria Gomez</a>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://maria-gomez.me//posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://maria-gomez.me//talks/divide-and-conquer-an-introduction-to-microservices/" title="Divide and Conquer - an introduction to Microservices">Divide and Conquer - an introduction to Microservices</a></li>
    
      <li><a href="http://maria-gomez.me//talks/divide-y-venceras-una-introduccion-a-los-microservices/" title="Divide y Vencerás - una introducción a los Microservices">Divide y Vencerás - una introducción a los Microservices</a></li>
    
      <li><a href="http://maria-gomez.me//talks/refactoring-workshop/" title="Refactoring workshop">Refactoring workshop</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  <footer>
    <span>&copy; 2015 Maria Gomez. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/minimal-mistakes/">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://maria-gomez.me//assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://maria-gomez.me//assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', '{"provider"=>"google", "google"=>{"tracking_id"=>"UA-55460651-1"}}']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'maria-gomez'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	        

</body>
</html>